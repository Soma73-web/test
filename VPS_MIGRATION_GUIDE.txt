# VPS Migration Guide for vagusscience.online

This guide will help you move your full-stack app to a new VPS from scratch.

---

## 1. Prepare the New VPS

```bash
sudo apt update && sudo apt upgrade -y
sudo apt install git nginx nodejs npm pm2 mysql-server -y
```

---

## 2. Clone Your Repository

```bash
git clone https://github.com/Soma73-web/vagus.git
cd vagus
git checkout master-1
```

---

## 3. Set Up the Database

1. **Install MySQL (if not already done):**
   ```bash
   sudo apt install mysql-server -y
   ```
2. **Secure MySQL (optional):**
   ```bash
   sudo mysql_secure_installation
   ```
3. **Create the database and user:**
   ```bash
   sudo mysql -u root -p
   # In the MySQL shell:
   CREATE DATABASE your_database_name;
   CREATE USER 'your_mysql_user'@'localhost' IDENTIFIED BY 'your_mysql_password';
   GRANT ALL PRIVILEGES ON your_database_name.* TO 'your_mysql_user'@'localhost';
   FLUSH PRIVILEGES;
   EXIT;
   ```
4. **Import your data (if you have a dump):**
   ```bash
   mysql -u your_mysql_user -p your_database_name < /path/to/your_dump.sql
   ```

---

## 4. Set Up Environment Variables

- Copy your `.env` files from the old VPS or create new ones:

### backend/.env
```
DB_HOST=localhost
DB_USER=your_mysql_user
DB_PASSWORD=your_mysql_password
DB_NAME=your_database_name
DB_PORT=3306
JWT_SECRET=your_super_secret_jwt_key
PORT=5000
NODE_ENV=production
OPENAI_API_KEY=your_openai_api_key
PERPLEXITY_API_KEY=your_perplexity_api_key
FRONTEND_URL=https://vagusscience.online
```

### client/.env
```
REACT_APP_API_BASE_URL=https://vagusscience.online
```

---

## 5. Install Project Dependencies

### Backend
```bash
cd ~/vagus/backend
npm install
```

### Frontend
```bash
cd ~/vagus/client
npm install
```

---

## 6. Build the Frontend

```bash
cd ~/vagus/client
npm run build
```

---

## 7. Set Up Nginx

1. **Create/Edit Nginx config:**
   ```bash
   sudo nano /etc/nginx/sites-available/vagus
   ```
   Paste:
   ```nginx
   server {
       listen 80;
       server_name vagusscience.online www.vagusscience.online;
       return 301 https://$host$request_uri;
   }
   server {
       listen 443 ssl;
       server_name vagusscience.online www.vagusscience.online;
       root /home/azureuser/vagus/client/build;
       index index.html index.htm;
       ssl_certificate /etc/letsencrypt/live/vagusscience.online/fullchain.pem;
       ssl_certificate_key /etc/letsencrypt/live/vagusscience.online/privkey.pem;
       ssl_protocols TLSv1.2 TLSv1.3;
       ssl_ciphers HIGH:!aNULL:!MD5;
       location / {
           try_files $uri /index.html;
       }
       location /api/ {
           proxy_pass http://localhost:5000;
           proxy_set_header Host $host;
           proxy_set_header X-Real-IP $remote_addr;
           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
           proxy_set_header X-Forwarded-Proto $scheme;
       }
   }
   ```
2. **Enable and reload Nginx:**
   ```bash
   sudo ln -s /etc/nginx/sites-available/vagus /etc/nginx/sites-enabled/
   sudo nginx -t
   sudo systemctl reload nginx
   ```

---

## 8. Set Up SSL (HTTPS)

```bash
sudo apt install certbot python3-certbot-nginx -y
sudo certbot --nginx -d vagusscience.online -d www.vagusscience.online
```
- Follow prompts to complete SSL setup.

---

## 9. Start the Backend with PM2

```bash
cd ~/vagus/backend
pm2 start server.js --name vagus-backend
pm2 save
```

---

## 10. Open Firewall Ports (Azure NSG)
- Allow ports 22 (SSH), 80 (HTTP), 443 (HTTPS).

---

## 11. Set Up GitHub Actions for Auto-Deploy (Optional)
- Add your SSH private key, VPS_HOST, and VPS_USER as GitHub secrets.
- Use this workflow in `.github/workflows/deploy.yml`:

```yaml
name: Deploy to VPS
on:
  push:
    branches:
      - master-1
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd ~/vagus
            git fetch origin
            git reset --hard origin/master-1
            cd backend
            npm install
            pm2 restart vagus-backend
            cd ../client
            npm install
            npm run build
```

---

## 12. (Optional) Copy Uploads and Data
- If you have user-uploaded files, copy the `backend/uploads` directory from the old VPS:
```bash
scp -r azureuser@old_vps_ip:~/vagus/backend/uploads ~/vagus/backend/
```

---

## 13. Test Everything
- Visit https://vagusscience.online
- Test admin, uploads, downloads, chatbot, etc.
- Check logs:
  - Backend: `pm2 logs vagus-backend`
  - Nginx: `sudo tail -n 50 /var/log/nginx/error.log`

---

**You are done!**

---

# Quick Reference
- Project root: `~/vagus`
- Backend: `~/vagus/backend`
- Frontend: `~/vagus/client`
- Nginx config: `/etc/nginx/sites-available/vagus`
- SSL certs: `/etc/letsencrypt/live/vagusscience.online/`
- PM2 process: `vagus-backend`
- Main branch: `master-1` 